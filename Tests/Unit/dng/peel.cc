/*
 * Copyright (c) 2016 Steven H. Wu
 * Copyright (c) 2016 Reed A. Cartwright
 * Authors:  Steven H. Wu <stevenwu@asu.edu>
 *           Reed A. Cartwright <reed@cartwrig.ht>
 *
 * This file is part of DeNovoGear.
 *
 * DeNovoGear is free software: you can redistribute it and/or modify it under
 * the terms of the GNU General Public License as published by the Free Software
 * Foundation; either version 3 of the License, or (at your option) any later
 * version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with
 * this program. If not, see <http://www.gnu.org/licenses/>.
 */

#define BOOST_TEST_MODULE dng::peel

#include <string>
#include <cstdlib>
#include <ctime>
#include <iostream>
#include <random>

#include <dng/peeling.h>
#include <dng/mutation.h>

#include "../boost_test_helper.h"
#include "fixture_random_family.h"

using namespace dng;

const int NUM_TEST = 100;

std::random_device rd;
std::mt19937 random_gen_mt(rd());


struct TestData {

    std::string fixture;

    int total_family_size;
    dng::peel::family_members_t family_2;
    dng::peel::family_members_t family_3;
    dng::peel::family_members_t family_4;
    std::vector<TransitionMatrix> trans_matrix;
    std::vector<GenotypeArray> upper_array;
    std::vector<GenotypeArray> lower_array;

    TestData(std::string s = "TestData") : fixture(s) {
        BOOST_TEST_MESSAGE("set up fixture " << s);

        total_family_size = 4;

        family_2 = {0,1}; //up, down
        family_3 = {0,1,2}; //to_parent
        family_4 = {0,1,2,3}; //to_child

        lower_array.resize(total_family_size, GenotypeArray(10));
        upper_array.resize(total_family_size, GenotypeArray(10));
        trans_matrix.resize(total_family_size);
        trans_matrix[0].resize(10, 10);
        trans_matrix[1].resize(10, 10);
        trans_matrix[2].resize(100, 10);
        trans_matrix[3].resize(100, 10);

        lower_array[0] << 0.896697200136259, 0.2655086631421, 0.37212389963679, 0.572853363351896, 0.908207789994776, 0.201681931037456, 0.898389684967697, 0.944675268605351, 0.660797792486846, 0.62911404389888;
        lower_array[1] << 0.0617862704675645, 0.205974574899301, 0.176556752528995, 0.687022846657783, 0.384103718213737, 0.769841419998556, 0.497699242085218, 0.717618508264422, 0.991906094830483, 0.380035179434344;
        lower_array[2] << 0.777445221319795, 0.934705231105909, 0.212142521282658, 0.651673766085878, 0.125555095961317, 0.267220668727532, 0.386114092543721, 0.0133903331588954, 0.382387957070023, 0.86969084572047;
        lower_array[3] << 0.34034899668768, 0.482080115471035, 0.599565825425088, 0.493541307048872, 0.186217601411045, 0.827373318606988, 0.668466738192365, 0.79423986072652, 0.107943625887856, 0.723710946040228;
        upper_array[0] << 0.411274429643527, 0.820946294115856, 0.647060193819925, 0.78293276228942, 0.553036311641335, 0.529719580197707, 0.789356231689453, 0.023331202333793, 0.477230065036565, 0.7323137386702;
        upper_array[1] << 0.692731556482613, 0.477619622135535, 0.8612094768323, 0.438097107224166, 0.244797277031466, 0.0706790471449494, 0.0994661601725966, 0.31627170718275, 0.518634263193235, 0.662005076417699;
        upper_array[2] << 0.406830187188461, 0.912875924259424, 0.293603372760117, 0.459065726259723, 0.332394674187526, 0.65087046707049, 0.258016780717298, 0.478545248275623, 0.766310670645908, 0.0842469143681228;
        upper_array[3] << 0.875321330036968, 0.339072937844321, 0.839440350187942, 0.34668348915875, 0.333774930797517, 0.476351245073602, 0.892198335845023, 0.864339470630512, 0.389989543473348, 0.777320698834956;
        trans_matrix[0] << 0.960617997217923, 0.434659484773874, 0.712514678714797, 0.399994368897751, 0.325352151878178, 0.757087148027495, 0.202692255144939, 0.711121222469956, 0.121691921027377, 0.245488513959572, 0.14330437942408, 0.239629415096715, 0.0589343772735447, 0.642288258532062, 0.876269212691113, 0.778914677444845, 0.79730882588774, 0.455274453619495, 0.410084082046524, 0.810870242770761, 0.604933290276676, 0.654723928077146, 0.353197271935642, 0.270260145887733, 0.99268406117335, 0.633493264438584, 0.213208135217428, 0.129372348077595, 0.478118034312502, 0.924074469832703, 0.59876096714288, 0.976170694921166, 0.731792511884123, 0.356726912083104, 0.431473690550774, 0.148211560677737, 0.0130775754805654, 0.715566066093743, 0.103184235747904, 0.446284348610789, 0.640101045137271, 0.991838620044291, 0.495593577856198, 0.484349524369463, 0.173442334868014, 0.754820944508538, 0.453895489219576, 0.511169783771038, 0.207545113284141, 0.228658142732456, 0.595711996313184, 0.57487219828181, 0.0770643802825361, 0.0355405795853585, 0.642795492196456, 0.928615199634805, 0.598092422354966, 0.560900748008862, 0.526027723914012, 0.985095223877579, 0.507641822332516, 0.682788078673184, 0.601541217649356, 0.238868677755818, 0.258165926672518, 0.729309623362496, 0.452570831403136, 0.175126768415794, 0.746698269620538, 0.104987640399486, 0.864544949028641, 0.614644971676171, 0.557159538846463, 0.328777319053188, 0.453131445450708, 0.500440972624347, 0.180866361130029, 0.529630602803081, 0.0752757457084954, 0.277755932649598, 0.212699519237503, 0.284790480975062, 0.895094102947041, 0.4462353233248, 0.779984889784828, 0.880619034869596, 0.413124209502712, 0.0638084805104882, 0.335487491684034, 0.723725946620107, 0.337615333497524, 0.630414122482762, 0.840614554006606, 0.856131664710119, 0.39135928102769, 0.380493885604665, 0.895445425994694, 0.644315762910992, 0.741078648716211, 0.605303446529433;
        trans_matrix[1] << 0.903081611497328, 0.293730155099183, 0.19126010988839, 0.886450943304226, 0.503339485730976, 0.877057543024421, 0.189193622441962, 0.758103052387014, 0.724498892668635, 0.943724818294868, 0.547646587016061, 0.711743867723271, 0.388905099825934, 0.100873126182705, 0.927302088588476, 0.283232500310987, 0.59057315881364, 0.110360604943708, 0.840507032116875, 0.317963684443384, 0.782851336989552, 0.267508207354695, 0.218645284883678, 0.516796836396679, 0.268950592027977, 0.181168327340856, 0.518576137488708, 0.562782935798168, 0.129156854469329, 0.256367604015395, 0.717935275984928, 0.961409936426207, 0.100140846567228, 0.763222689507529, 0.947966354666278, 0.818634688388556, 0.308292330708355, 0.649579460499808, 0.953355451114476, 0.953732650028542, 0.339979203417897, 0.262474110117182, 0.165453933179379, 0.322168056620285, 0.510125206550583, 0.923968471353874, 0.510959698352963, 0.305707359686494, 0.0464608869515359, 0.41785625834018, 0.854001502273604, 0.347230677725747, 0.131442320533097, 0.374486864544451, 0.631420228397474, 0.390078933676705, 0.689627848798409, 0.689413412474096, 0.554900623159483, 0.429624407785013, 0.452720062807202, 0.306443258887157, 0.578353944001719, 0.910370304249227, 0.142604082124308, 0.415047625312582, 0.210925750667229, 0.428750370861962, 0.132689975202084, 0.460096445865929, 0.942957059247419, 0.761973861604929, 0.932909828843549, 0.470678497571498, 0.603588067693636, 0.484989680582657, 0.10880631650798, 0.247726832982153, 0.498514530714601, 0.372866708086804, 0.934691370232031, 0.523986077867448, 0.317144671687856, 0.277966029476374, 0.787540507735685, 0.702462512534112, 0.165027638664469, 0.0644575387705117, 0.754705621628091, 0.620410033036023, 0.169576766667888, 0.0622140523046255, 0.109029268613085, 0.381716351723298, 0.169310914585367, 0.298652542056516, 0.192209535045549, 0.257170021301135, 0.181231822818518, 0.477313709678128;
        trans_matrix[2] << 0.770737042883411, 0.0277871224097908, 0.527310776989907, 0.880319068906829, 0.373063371982425, 0.0479591316543519, 0.138628246728331, 0.321492120390758, 0.154831611318514, 0.132228172151372, 0.221305927727371, 0.226380796171725, 0.13141653384082, 0.981563460314646, 0.327013726811856, 0.506939497077838, 0.68144251476042, 0.0991691031958908, 0.118902558228001, 0.0504396595060825, 0.929253919748589, 0.673712232848629, 0.0948578554671258, 0.492596120806411, 0.461551840649918, 0.375216530868784, 0.991099219536409, 0.176350713707507, 0.813435208518058, 0.0684466371312737, 0.40044974675402, 0.141144325723872, 0.193309862399474, 0.841351716779172, 0.719913988374174, 0.267212083097547, 0.495001644827425, 0.0831138978246599, 0.353884240612388, 0.969208805356175, 0.624714189674705, 0.664618249749765, 0.312489656498656, 0.405689612729475, 0.996077371528372, 0.855082356370986, 0.953548396006227, 0.812305092345923, 0.782182115828618, 0.267878128914163, 0.762151529546827, 0.986311589134857, 0.293605549028143, 0.399351106956601, 0.812131523853168, 0.0771516691893339, 0.363696809858084, 0.442592467181385, 0.156714132521302, 0.582205270184204, 0.970162178855389, 0.98949983343482, 0.176452036481351, 0.542130424408242, 0.384303892031312, 0.676164050819352, 0.26929377974011, 0.469250942347571, 0.171800082316622, 0.36918946239166, 0.725405272562057, 0.486149104312062, 0.0638024667277932, 0.784546229988337, 0.418321635806933, 0.981018084799871, 0.282883955864236, 0.847882149508223, 0.0822392308618873, 0.886458750581369, 0.471930730855092, 0.109100963454694, 0.333277984522283, 0.837416569236666, 0.276849841699004, 0.587035141419619, 0.836732269730419, 0.0711540239863098, 0.702778743347153, 0.69882453721948, 0.46396238100715, 0.436931110452861, 0.562176787760109, 0.928483226336539, 0.230466414242983, 0.221813754411414, 0.420215893303975, 0.333520805696025, 0.864807550329715, 0.177194535732269, 0.49331872863695, 0.429713366786018, 0.564263842999935, 0.656162315513939, 0.97855406277813, 0.232161148451269, 0.240811596158892, 0.796836083987728, 0.831671715015545, 0.113507706439123, 0.963312016334385, 0.147322899661958, 0.143626942764968, 0.925229935208336, 0.507035602582619, 0.15485101705417, 0.348302052123472, 0.659821025794372, 0.311772374436259, 0.351573409279808, 0.147845706902444, 0.658877609064803, 0.185069964500144, 0.954378136899322, 0.897848492022604, 0.943697054404765, 0.72369075124152, 0.370357065927237, 0.781017540255561, 0.011149508645758, 0.940308712190017, 0.993749226210639, 0.3574057451915, 0.747635063482448, 0.792909023817629, 0.705859006382525, 0.475825038738549, 0.494654526002705, 0.308052448788658, 0.695012246258557, 0.822793305618688, 0.434717640746385, 0.514732652809471, 0.663010967662558, 0.143166586523876, 0.344487393740565, 0.405763582326472, 0.0853110058233142, 0.932571928249672, 0.838384066708386, 0.879433296155185, 0.935712467646226, 0.0724606334697455, 0.378759440500289, 0.537864922778681, 0.105050138663501, 0.801687705563381, 0.739641745807603, 0.052149013383314, 0.482169573195279, 0.920517840655521, 0.0415284289047122, 0.293991799000651, 0.500850487267599, 0.609748935094103, 0.264249049592763, 0.423098609549925, 0.366563616320491, 0.942505322396755, 0.123723565135151, 0.0700326792430133, 0.964317037956789, 0.442510108230636, 0.370272380299866, 0.141185086918995, 0.0541904293932021, 0.657828069292009, 0.578161916695535, 0.987101763952523, 0.603792401496321, 0.0649499187711626, 0.16210908186622, 0.475397920468822, 0.00193283474072814, 0.441459143068641, 0.260929737240076, 0.938413745490834, 0.715833283727989, 0.163085478357971, 0.476188018452376, 0.690256722969934, 0.460895179538056, 0.95514673832804, 0.712540122447535, 0.397147933254018, 0.117720612091944, 0.24011627305299, 0.863630566513166, 0.435976401669905, 0.497868051985279, 0.691927672130987, 0.760313281789422, 0.155401222640648, 0.849457093048841, 0.946817819029093, 0.588419190375134, 0.502250815276057, 0.189779917709529, 0.00183685822412372, 0.877578062238172, 0.134111337829381, 0.0227412241511047, 0.939136706059799, 0.292948722839355, 0.164326574420556, 0.399102555820718, 0.459575412096456, 0.434030848555267, 0.517009826377034, 0.846245752647519, 0.0551642864011228, 0.554177061188966, 0.688275237567723, 0.658057553693652, 0.663342725252733, 0.472234202548862, 0.969528166111559, 0.402197062736377, 0.849552103783935, 0.756644907407463, 0.532601219369099, 0.874149660812691, 0.467115115607157, 0.00812845537438989, 0.72776700463146, 0.716589478775859, 0.187426371034235, 0.646067276829854, 0.541979279834777, 0.335320759797469, 0.637908723205328, 0.829201063839719, 0.708975198445842, 0.348550350870937, 0.128327874932438, 0.38807848887518, 0.92817754833959, 0.804390771314502, 0.758696807082742, 0.957249888917431, 0.993913878686726, 0.606440994655713, 0.0293771654833108, 0.336445357883349, 0.277658086735755, 0.117197550134733, 0.0432182590011507, 0.370309785706922, 0.33687830879353, 0.173652553465217, 0.621773279504851, 0.397843627491966, 0.955675768665969, 0.653349443105981, 0.328743716701865, 0.197146713500842, 0.115342324832454, 0.995965478708968, 0.379276725230739, 0.561988092726097, 0.732718017650768, 0.870805552927777, 0.572170259663835, 0.0110360709950328, 0.906315261265263, 0.770653631538153, 0.382504623383284, 0.0940458888653666, 0.0496535839047283, 0.821162318112329, 0.829324304359034, 0.654732875758782, 0.132827813038602, 0.341809901176021, 0.731371578993276, 0.907291416078806, 0.696196999400854, 0.241579222260043, 0.644107228610665, 0.280750213656574, 0.957636520732194, 0.158395956736058, 0.418338991701603, 0.252009797375649, 0.0943902677390724, 0.827717769658193, 0.525305503746495, 0.667747627478093, 0.408277759794146, 0.842589903390035, 0.737305467948318, 0.348224401008338, 0.948938177432865, 0.646679189987481, 0.03527776687406, 0.596448455704376, 0.415318001527339, 0.0768970381468534, 0.52804887923412, 0.962333308532834, 0.708740051137283, 0.553475703578442, 0.242956608999521, 0.778042529011145, 0.651940943440422, 0.830245703924447, 0.648550947429612, 0.479835794307292, 0.495064105605707, 0.379872591467574, 0.450485437177122, 0.814251750474796, 0.928777225781232, 0.147481045220047, 0.749821664998308, 0.975657349685207, 0.974792463472113, 0.350625570164993, 0.393949056975543, 0.950951009057462, 0.106648319633678, 0.934760116506368, 0.346162099856883, 0.53306060587056, 0.538794299354777, 0.714717949740589, 0.405790500110015, 0.152788141276687, 0.340232761343941, 0.62665484752506, 0.0573726783040911, 0.851667639799416, 0.212645345833153, 0.768248430453241, 0.136487586190924, 0.324865140486509, 0.621076293755323, 0.255982248578221, 0.634875798830763, 0.485672106966376, 0.938176916679367, 0.857501537073404, 0.370883537689224, 0.314201829954982, 0.828534359810874, 0.451841513160616, 0.315878412220627, 0.0978085375390947, 0.0649005365557969, 0.689457366475835, 0.668050603941083, 0.90454664779827, 0.301693270448595, 0.932808704674244, 0.201983017381281, 0.792378755984828, 0.224630508804694, 0.0307565710972995, 0.862034041201696, 0.685107505181804, 0.942074909573421, 0.675853760447353, 0.843120148405433, 0.361894184956327, 0.392365885199979, 0.567687397589907, 0.0951521336100996, 0.193784071598202, 0.588066393043846, 0.751504168147221, 0.867238787235692, 0.371795737184584, 0.798814549576491, 0.0583143925759941, 0.623435709392652, 0.356641406659037, 0.587927932385355, 0.913784642005339, 0.199442182900384, 0.369083623867482, 0.671408327762038, 0.768144550733268, 0.522248276043683, 0.828075018012896, 0.52709619468078, 0.501754825003445, 0.419973319862038, 0.362298283260316, 0.123428910272196, 0.298161529470235, 0.276676489738747, 0.791456031380221, 0.77818130212836, 0.143787280656397, 0.515526150586084, 0.597240485483781, 0.505843024002388, 0.386099633062258, 0.426098100841045, 0.0117597347125411, 0.919331770390272, 0.0794396931305528, 0.507374254753813, 0.820171616971493, 0.5983954181429, 0.424153526080772, 0.559310270706192, 0.789094472071156, 0.167715257965028, 0.970451730070636, 0.473503098357469, 0.929743205895647, 0.900939270388335, 0.750882187858224, 0.676568772410974, 0.648013445781544, 0.0732468697242439, 0.423558418406174, 0.530824364162982, 0.942704762332141, 0.71222455939278, 0.724490575492382, 0.470128617715091, 0.120282255811617, 0.783097670879215, 0.438157397089526, 0.431455979822204, 0.0274978789966553, 0.146561842877418, 0.422595157986507, 0.767137174261734, 0.0047664453741163, 0.603595691500232, 0.90557726053521, 0.706661531934515, 0.2625371592585, 0.851076219463721, 0.333605515072122, 0.578284267568961, 0.432773130247369, 0.0515953230205923, 0.729803287889808, 0.548170414287597, 0.751221985556185, 0.0507711647078395, 0.714966212399304, 0.297694456763566, 0.28347720974125, 0.829877127427608, 0.0863953751977533, 0.0426571189891547, 0.348740808898583, 0.542336010141298, 0.609460863517597, 0.271372098475695, 0.205230931984261, 0.38163214828819, 0.47255811537616, 0.835517949890345, 0.121471496298909, 0.675808124942705, 0.496685219928622, 0.90223774779588, 0.551263966830447, 0.12856467650272, 0.442009785678238, 0.192297696368769, 0.434900622116402, 0.225133402971551, 0.961096282117069, 0.448427465045825, 0.77714498527348, 0.158219774486497, 0.866808582562953, 0.206145605770871, 0.177949683042243, 0.16489114635624, 0.565268977312371, 0.727181021124125, 0.87591898906976, 0.7084243837744, 0.47746321093291, 0.820279993582517, 0.0166122107766569, 0.996111101238057, 0.63489483576268, 0.42847538087517, 0.0283929328434169, 0.753332700580359, 0.20863397535868, 0.999455405166373, 0.907249193172902, 0.712465031770989, 0.730932883918285, 0.472487921128049, 0.86251068697311, 0.165415122406557, 0.620427925605327, 0.29233139497228, 0.456141733797267, 0.0456392089836299, 0.177661752095446, 0.0579320678953081, 0.944410233525559, 0.342743474291638, 0.517950570676476, 0.625245335279033, 0.23726485366933, 0.516123914392665, 0.806541827740148, 0.348264734493569, 0.858687452971935, 0.034438761183992, 0.970997145865113, 0.745110136223957, 0.273255241801962, 0.677106101531535, 0.347947468049824, 0.947020521620288, 0.338623774936423, 0.0317132039926946, 0.35358579759486, 0.387123587774113, 0.356947160093114, 0.959968606010079, 0.383738204836845, 0.546337621053681, 0.925323475850746, 0.916859527118504, 0.24273299286142, 0.717090838821605, 0.348946035839617, 0.5542833507061, 0.74297241307795, 0.819698318606243, 0.869657265022397, 0.0358651343267411, 0.220024403417483, 0.3669732096605, 0.305696442024782, 0.727830457501113, 0.699728766223416, 0.910060926806182, 0.845602609682828, 0.778544640168548, 0.400843428215012, 0.576804658863693, 0.0763594461604953, 0.872974850703031, 0.956285735592246, 0.505531079834327, 0.924366363789886, 0.134513532742858, 0.238737003179267, 0.489962622057647, 0.474060096777976, 0.434994159033522, 0.0392489600926638, 0.644331015180796, 0.715567200211808, 0.351666721282527, 0.946556748822331, 0.74310650723055, 0.0507859203498811, 0.98036478087306, 0.217822452541441, 0.0361960020381957, 0.2607038654387, 0.720415785908699, 0.247894181171432, 0.234915791545063, 0.021011842880398, 0.264620627742261, 0.691801619483158, 0.0346693911124021, 0.0627861295361072, 0.397706091869622, 0.490028424886987, 0.631048747571185, 0.723404312273487, 0.0767657924443483, 0.421446080552414, 0.9737266858574, 0.813805783400312, 0.223767722956836, 0.489742305828258, 0.0113401929847896, 0.258602296933532, 0.454598771873862, 0.740976688219234, 0.990660011768341, 0.332204946083948, 0.944791405461729, 0.961853419896215, 0.899277499644086, 0.492715835105628, 0.784935477888212, 0.803119047079235, 0.677767623681575, 0.581277578603476, 0.330668087350205, 0.00131465657614172, 0.0658019641414285, 0.0859519173391163, 0.0131097168195993, 0.335745624266565, 0.119264316512272, 0.593595445388928, 0.0373126757331192, 0.00957179185934365, 0.161596125923097, 0.831898988224566, 0.766842754324898, 0.272780316416174, 0.188163298880681, 0.225761834764853, 0.0619703675620258, 0.0599002409726381, 0.16546886600554, 0.0729878859128803, 0.042885891860351, 0.522461272310466, 0.789231489412487, 0.69475334812887, 0.06657604733482, 0.0179577465169132, 0.442158423364162, 0.157602083170786, 0.718860115855932, 0.703941832529381, 0.885226304875687, 0.325261015212163, 0.970881566638127, 0.984820266254246, 0.0391847176942974, 0.893571288092062, 0.82239915127866, 0.724244692828506, 0.288920137798414, 0.501948604593053, 0.428347001317888, 0.610016016056761, 0.926113174064085, 0.240123257739469, 0.271881833905354, 0.735003646463156, 0.751545873004943, 0.930591920856386, 0.462730274768546, 0.860691176727414, 0.312036419520155, 0.208039013436064, 0.920827467227355, 0.0527368842158467, 0.411155431065708, 0.456341215176508, 0.415860247565433, 0.670353451743722, 0.756904080044478, 0.911651314469054, 0.819952085847035, 0.0936498525552452, 0.177906081313267, 0.6422145802062, 0.874282993841916, 0.592313350411132, 0.262432192219421, 0.883752264082432, 0.187689346261322, 0.488866982283071, 0.0098204871173948, 0.360434043221176, 0.442161690909415, 0.125729221384972, 0.6243645476643, 0.302431331714615, 0.239637228194624, 0.358629763592035, 0.89291041251272, 0.990627265069634, 0.732421197462827, 0.99278808827512, 0.53978936211206, 0.433801761828363, 0.96467367419973, 0.148319643223658, 0.0664930557832122, 0.0242514880374074, 0.61242324183695, 0.696608748054132, 0.801141887204722, 0.137730283895507, 0.15978482272476, 0.988833592971787, 0.398645695531741, 0.187911816174164, 0.477728241123259, 0.544234022730961, 0.328157980693504, 0.999930593650788, 0.527781835990027, 0.133734508184716, 0.438540067756549, 0.620793939800933, 0.202912412118167, 0.134169772733003, 0.776833998039365, 0.635949848685414, 0.282136296620592, 0.191259456099942, 0.265536719933152, 0.530808792915195, 0.684860904002562, 0.383283393690363, 0.954987998353317, 0.118356580613181, 0.0391000553499907, 0.504505032906309, 0.578482555225492, 0.839303907938302, 0.654444975312799, 0.944528339896351, 0.511657629627734, 0.0849210591986775, 0.994770509423688, 0.401444119866937, 0.895646296674386, 0.876858412055299, 0.296484797960147, 0.132591909728944, 0.265910907648504, 0.00572754279710352, 0.819601821480319, 0.174661678960547, 0.84308055206202, 0.16671216674149, 0.76401943503879, 0.518938087392598, 0.272685303352773, 0.343203135766089, 0.705075340112671, 0.591535301180556, 0.469379037618637, 0.336376605555415, 0.967837428674102, 0.645841883728281, 0.196301169227809, 0.357180385151878, 0.513018082128838, 0.882996740518138, 0.152667565271258, 0.230461597442627, 0.162988578435034, 0.614346859045327, 0.501636443892494, 0.188118888065219, 0.407714852597564, 0.582388046896085, 0.308929065009579, 0.480965640163049, 0.939394792309031, 0.0460405482444912, 0.534861729713157, 0.44266078225337, 0.906365469563752, 0.881042381748557, 0.163241116330028, 0.752190765691921, 0.402987202163786, 0.556952693499625, 0.0801692819222808, 0.116568592377007, 0.925192561233416, 0.878844240680337, 0.163207626901567, 0.531563901342452, 0.929792168317363, 0.325715993763879, 0.160794630879536, 0.949707917869091, 0.462357048643753, 0.220770887332037, 0.00201923260465264, 0.619192603277043, 0.40250592213124, 0.900032610632479, 0.505881984485313, 0.96598515030928, 0.027486614882946, 0.379413213115185, 0.386744662187994, 0.337820725282654, 0.364431851310655, 0.638755969703197, 0.0329143274575472, 0.69619258842431, 0.815564174670726, 0.507422853494063, 0.112592625897378, 0.906323301140219, 0.413338953163475, 0.473755787825212, 0.713714180048555, 0.241871210513636, 0.299640627577901, 0.704478821484372, 0.771674948045984, 0.0138403405435383, 0.551313953474164, 0.652461190475151, 0.931660708039999, 0.690391705138609, 0.253767139045522, 0.411038370104507, 0.122891113162041, 0.13196655572392, 0.640118008246645, 0.346423432230949, 0.422756604617462, 0.939408880425617, 0.383889230899513, 0.228585131000727, 0.69027868588455, 0.00985791743732989, 0.686130894348025, 0.791674596024677, 0.507493488723412, 0.308076248969883, 0.737212277250364, 0.304715243401006, 0.774708701763302, 0.112113637849689, 0.797743699979037, 0.491001167334616, 0.832918174797669, 0.758423154940829, 0.902146560838446, 0.278440013062209, 0.445692849811167, 0.272015735739842, 0.329918325645849, 0.863600653829053, 0.109857953386381, 0.402256899746135, 0.406075093662366, 0.375194273656234, 0.177000096300617, 0.265730200102553, 0.659550013486296, 0.816055504838005, 0.421184344682842, 0.160064304247499, 0.288610127288848, 0.802129008341581, 0.164245681837201, 0.789792735129595, 0.524214969947934, 0.320035002660006, 0.275177087867633, 0.8018980382476, 0.104024431202561, 0.838122266577557, 0.0792628736235201, 0.717564067104831, 0.864617826649919, 0.97855820809491, 0.249126207549125, 0.0248606903478503, 0.22297823196277, 0.122025499586016, 0.385239424882457, 0.0843304744921625, 0.28258189978078, 0.566582458792254, 0.328542302362621, 0.943474682746455, 0.377303513931111, 0.953315612394363, 0.273252867627889, 0.687330156099051, 0.136991804465652, 0.810210771625862, 0.762604692019522, 0.442404833855107, 0.456675694556907, 0.680455088848248, 0.0743979089893401, 0.646629075054079, 0.789914111606777, 0.223316506715491, 0.0409439904615283, 0.384648363338783, 0.344092153944075, 0.446368692209944, 0.38683316949755, 0.918317915406078, 0.174017543438822, 0.149870562367141, 0.613199228886515, 0.017243331996724, 0.0661104843020439, 0.778839041478932, 0.935656127054244, 0.207204139558598, 0.64334315690212, 0.331379575189203, 0.955421590944752, 0.817189157009125, 0.740276143187657, 0.222705976804718, 0.0457247165031731, 0.366526579251513, 0.741393025033176, 0.933506249915808, 0.673209949862212, 0.70135710737668, 0.847625407855958, 0.706156654981896, 0.85880775959231, 0.44564449111931, 0.676634992007166, 0.127824782626703, 0.736171535216272, 0.0672451483551413, 0.2808000696823, 0.411617683712393, 0.943424997152761, 0.97734253318049, 0.0388665851205587, 0.587727777194232, 0.0300116771832108, 0.565281208371744, 0.0982272308319807, 0.630290788598359, 0.818501834524795, 0.350041663041338, 0.133983674924821, 0.080943378387019, 0.350443314295262, 0.996271784650162, 0.532968810759485, 0.335897380486131, 0.314234643476084, 0.382622060365975, 0.018546407809481, 0.0365391168743372, 0.878513294039294, 0.402064023772255, 0.469381074188277, 0.402336510131136, 0.702090102480724, 0.399164465256035, 0.501958322711289, 0.0369737506844103, 0.297975734807551, 0.962841981789097, 0.540701985592023, 0.961099177366123, 0.792595364153385, 0.754777192836627, 0.065966630121693, 0.135504779173061, 0.123599375598133, 0.762543860822916, 0.903465715935454, 0.402659090235829, 0.182563007809222, 0.37456521904096, 0.506208677310497, 0.9135026789736, 0.0766451810486615, 0.109745523892343, 0.754267222480848, 0.304598775692284, 0.72380965645425, 0.232330028899014, 0.393458866979927, 0.507879396900535, 0.939916865434498, 0.0578751706052572, 0.304765704553574, 0.240924044046551, 0.385203435085714, 0.762983355671167, 0.864646998699754, 0.679111215053126, 0.676762705435976, 0.165052519412711, 0.802867429330945, 0.711993431439623;
        trans_matrix[3] << 0.928703089011833, 0.00749460491351783, 0.596331653418019, 0.366745680803433, 0.741967155365273, 0.762087390525267, 0.260722959181294, 0.254935881355777, 0.678840809967369, 0.485480662435293, 0.378584530204535, 0.0555479826871306, 0.899025898426771, 0.801723313750699, 0.481013050070032, 0.0321287591941655, 0.51200681226328, 0.373101272154599, 0.498571684816852, 0.399265736807138, 0.0209469445981085, 0.524289028486237, 0.1603988497518, 0.205114235170186, 0.975226715672761, 0.966354875126854, 0.760070322314277, 0.0763705321587622, 0.515823876019567, 0.600305194500834, 0.437024090904742, 0.00164226116612554, 0.435551518108696, 0.500963768921793, 0.669604706112295, 0.694857106776908, 0.782510314369574, 0.139022845542058, 0.163245677249506, 0.759542910149321, 0.443703617434949, 0.629668830428272, 0.104512860300019, 0.835548897273839, 0.333949361927807, 0.199519188608974, 0.694545476464555, 0.165878762723878, 0.0739639038220048, 0.0382361884694546, 0.846020216587931, 0.373548197327182, 0.880710697267205, 0.090317772468552, 0.495907411212102, 0.754322736058384, 0.605890813050792, 0.52841279655695, 0.91020668274723, 0.98572890390642, 0.279742561979219, 0.123491694685072, 0.17437904397957, 0.881335254758596, 0.124628272140399, 0.298968904651701, 0.164734639925882, 0.0726095444988459, 0.238413982093334, 0.716666605323553, 0.645020991796628, 0.0758749665692449, 0.172708922065794, 0.145670357858762, 0.391901184339076, 0.231745099416003, 0.561379822902381, 0.583520186599344, 0.098759338259697, 0.15891654137522, 0.922065404010937, 0.859449719078839, 0.904534135712311, 0.115268956404179, 0.0355392340570688, 0.585754387546331, 0.314168264856562, 0.556889274157584, 0.354495415464044, 0.143268311629072, 0.567135462770239, 0.334098657825962, 0.120401190593839, 0.255854324204847, 0.353385316440836, 0.831319929333404, 0.783223916543648, 0.940152207389474, 0.839199031703174, 0.148985019186512, 0.590676085092127, 0.823962600668892, 0.631885365350172, 0.469929961487651, 0.258740903576836, 0.0245803508441895, 0.328808127669618, 0.224853484425694, 0.877331839408726, 0.67765420069918, 0.52593330363743, 0.557686663931236, 0.247471673414111, 0.00729677081108093, 0.948906435165554, 0.719150138553232, 0.279324544593692, 0.743782856035978, 0.870748400921002, 0.380370125174522, 0.719447515904903, 0.239606710383669, 0.647764874156564, 0.975670760730281, 0.377998807933182, 0.464144128607586, 0.812296295771375, 0.494408113183454, 0.0503090226557106, 0.130621740594506, 0.161438316106796, 0.0894531598314643, 0.403614088194445, 0.0638598678633571, 0.562005922431126, 0.336524107959121, 0.540642281062901, 0.913231221958995, 0.38688075914979, 0.960267164045945, 0.384686591336504, 0.941601979313418, 0.680635657161474, 0.902642353670672, 0.253797065699473, 0.406097129452974, 0.0142486135009676, 0.11044779419899, 0.501537791918963, 0.371526648057625, 0.805915554286912, 0.00792284356430173, 0.836512059206143, 0.37683917931281, 0.385248533217236, 0.951530575519428, 0.475674239452928, 0.552093794336542, 0.934716325020418, 0.86343625606969, 0.259914484340698, 0.687699834583327, 0.447907246183604, 0.21801627590321, 0.68623681506142, 0.959382025292143, 0.259404480922967, 0.468759991927072, 0.321339557645842, 0.164642814546824, 0.714727725367993, 0.52816575136967, 0.234714680118486, 0.0644316615071148, 0.67576349619776, 0.806145361857489, 0.115471235243604, 0.692014421336353, 0.0217862285207957, 0.361376708606258, 0.732280049938709, 0.312623041914776, 0.447153053246439, 0.825439068023115, 0.331795465201139, 0.144025167217478, 0.30092075210996, 0.162601796910167, 0.839471578365192, 0.664307477185503, 0.138867305591702, 0.325881813885644, 0.831430218880996, 0.717164812609553, 0.149399920366704, 0.421279689529911, 0.445182651514187, 0.883927375776693, 0.414997326675802, 0.689892161870375, 0.71692087710835, 0.0123791699297726, 0.0378294484689832, 0.0908774142153561, 0.398823967436329, 0.900214575929567, 0.444902628427371, 0.75515309209004, 0.711470239562914, 0.166756350314245, 0.869142389157787, 0.0891845354344696, 0.16301366337575, 0.849353688303381, 0.628130341181532, 0.208459950983524, 0.672860826831311, 0.964205690892413, 0.88173885201104, 0.961764686973765, 0.464693185640499, 0.0728773572482169, 0.874308753525838, 0.198872806271538, 0.53458975860849, 0.105562190990895, 0.383995017269626, 0.747705924557522, 0.695790997939184, 0.0983917720150203, 0.611531793372706, 0.0209252538625151, 0.649712249170989, 0.978378070285544, 0.842504459200427, 0.842785842018202, 0.387452162569389, 0.79307110211812, 0.406196559080854, 0.253348905127496, 0.419303989037871, 0.495499532902613, 0.858245956944302, 0.732264853548259, 0.97442849050276, 0.100054909707978, 0.832590837031603, 0.450554177863523, 0.85045913583599, 0.569751543691382, 0.961542513919994, 0.729908488923684, 0.283779508899897, 0.739606497809291, 0.0707425756845623, 0.900119546800852, 0.13342057261616, 0.555886077694595, 0.600408032536507, 0.132961038965732, 0.509312337264419, 0.36704990756698, 0.00330454739741981, 0.0479798603337258, 0.882048450177535, 0.823517040116712, 0.413030900992453, 0.921733218012378, 0.477402933407575, 0.474994423566386, 0.657836067024618, 0.163320453837514, 0.0951943711843342, 0.861514792311937, 0.239879169734195, 0.555404131999239, 0.849406595109031, 0.349647580645978, 0.975738595239818, 0.869405530160293, 0.754124050959945, 0.223673420026898, 0.769816465443, 0.874713584315032, 0.0437931080814451, 0.199760707095265, 0.853742358274758, 0.652254128362983, 0.869332019239664, 0.813636587467045, 0.36144763790071, 0.0908958460204303, 0.574655290460214, 0.654730413574725, 0.822204776341096, 0.455575515050441, 0.984328898368403, 0.750398378120735, 0.13355568703264, 0.21517351269722, 0.848379537696019, 0.465341185452417, 0.915767790284008, 0.916557738324627, 0.819854583824053, 0.566901157610118, 0.615477161249146, 0.794800289906561, 0.439696548506618, 0.399153744103387, 0.565485285129398, 0.151647832011804, 0.807460845448077, 0.495641366345808, 0.140509183052927, 0.110289279138669, 0.110791063401848, 0.00471427943557501, 0.238404355244711, 0.878822879167274, 0.0772186573594809, 0.138538560131565, 0.0475245749112219, 0.0339188734069467, 0.916089018341154, 0.840200393926352, 0.1788714164868, 0.495267945108935, 0.306958527071401, 0.274376961868256, 0.128243855433539, 0.429381913272664, 0.695944963721558, 0.335060718469322, 0.701246433425695, 0.840534914750606, 0.882632006658241, 0.766589350067079, 0.322027627611533, 0.0421170077752322, 0.8927099222783, 0.638105145189911, 0.554493116214871, 0.766329948091879, 0.0968612944707274, 0.748016487574205, 0.875217987690121, 0.00766859552823007, 0.934916985454038, 0.406965658068657, 0.788763389689848, 0.976127624511719, 0.33340254588984, 0.787214820971712, 0.0893609160557389, 0.0436999020166695, 0.514933738159016, 0.0480893275234848, 0.0891961276065558, 0.688325521536171, 0.0348385337274522, 0.430910924449563, 0.759294051211327, 0.831796954618767, 0.382462516892701, 0.615554818883538, 0.344986650394276, 0.532278774073347, 0.260009106947109, 0.572860622312874, 0.905846678419039, 0.566021878505126, 0.0564868177752942, 0.102113745408133, 0.328341855900362, 0.990600507240742, 0.714365339372307, 0.0789741838816553, 0.614216449437663, 0.493233672808856, 0.269097654847428, 0.293110862839967, 0.475278300233185, 0.964078546268865, 0.42363210208714, 0.844097095774487, 0.953827351331711, 0.28647352475673, 0.54084939789027, 0.581378317903727, 0.256286894436926, 0.878083968302235, 0.882302387617528, 0.987334684701636, 0.101620901143178, 0.618775002192706, 0.70473376987502, 0.148588430834934, 0.890810591634363, 0.162670300109312, 0.121866469504312, 0.977556857280433, 0.6271102654282, 0.0191994300112128, 0.829164144583046, 0.998877475271001, 0.868095516227186, 0.39691107487306, 0.936241782503203, 0.324772896012291, 0.972447561565787, 0.562598453834653, 0.579329037806019, 0.824690353590995, 0.198444477515295, 0.618989635026082, 0.224564614938572, 0.0252237301319838, 0.756505124736577, 0.638156944653019, 0.0578689130488783, 0.673797813244164, 0.691544770728797, 0.745228959713131, 0.124061870621517, 0.15117178671062, 0.177430625306442, 0.00886946776881814, 0.633788643172011, 0.372750885086134, 0.277720049023628, 0.172508500749245, 0.203711141366512, 0.221870881738141, 0.253431504592299, 0.170097689377144, 0.921676764031872, 0.345313458470628, 0.0851092091761529, 0.377817805157974, 0.54334351955913, 0.787010926054791, 0.320313527714461, 0.838038518326357, 0.998470485210419, 0.213442992419004, 0.437296491349116, 0.378729996271431, 0.965576708549634, 0.641116502229124, 0.806135333841667, 0.919062188826501, 0.0586224480066448, 0.477642855606973, 0.696882788324729, 0.0446715094149113, 0.756854316918179, 0.591673724818975, 0.510140463011339, 0.452601766446605, 0.0254819660913199, 0.961843609344214, 0.987627439666539, 0.634359558112919, 0.425541346892715, 0.266625905176625, 0.0805694879963994, 0.330141563434154, 0.894050102913752, 0.306675198487937, 0.40242384118028, 0.573791397502646, 0.596988384379074, 0.570017137564719, 0.218071287963539, 0.820126744452864, 0.0366557808592916, 0.625582814915106, 0.433478938182816, 0.35692613851279, 0.773667640052736, 0.173452047863975, 0.493208973202854, 0.737188908504322, 0.511001022765413, 0.475086916005239, 0.587899940554053, 0.572537379339337, 0.654917740728706, 0.865125555777922, 0.396846375893801, 0.960116155678406, 0.380877255229279, 0.170088279992342, 0.231604878557846, 0.949920209357515, 0.0835081576369703, 0.193044015904889, 0.074695295188576, 0.605016008019447, 0.215842896373942, 0.587987260660157, 0.228897603228688, 0.390925179235637, 0.347905913367867, 0.918379402486607, 0.112039123661816, 0.254976143594831, 0.186624069930986, 0.745543522993103, 0.932968782261014, 0.494711893843487, 0.644993681227788, 0.175802586833015, 0.602994646178558, 0.887757665943354, 0.490209404379129, 0.0183835725765675, 0.17939079226926, 0.299391138367355, 0.276964061195031, 0.0616094244178385, 0.35532134771347, 0.577037754002959, 0.535031558480114, 0.604272830300033, 0.486148978350684, 0.131626568036154, 0.96457004873082, 0.742461576359347, 0.366839384660125, 0.150825294898823, 0.226939673302695, 0.745116808917373, 0.050592377781868, 0.593993296846747, 0.158368041971698, 0.762780725024641, 0.995281064882874, 0.173998110694811, 0.619130822597072, 0.537983173970133, 0.818258262239397, 0.321746907196939, 0.582326936768368, 0.0709323794580996, 0.570644013117999, 0.56067725061439, 0.434170939493924, 0.96194878523238, 0.711271684383973, 0.258469532011077, 0.92567753768526, 0.420811663148925, 0.816300745587796, 0.754665047628805, 0.412143304478377, 0.514416832011193, 0.542284718481824, 0.974024304188788, 0.073637954890728, 0.76950380532071, 0.872554909205064, 0.989865584531799, 0.965147644048557, 0.636421318631619, 0.0653892939444631, 0.128414754988626, 0.492784780450165, 0.663244860246778, 0.189378713723272, 0.177598393289372, 0.115560325561091, 0.156952400226146, 0.8574108495377, 0.42486053169705, 0.878341671079397, 0.824826563941315, 0.978819616837427, 0.634543015854433, 0.691523276036605, 0.792183339362964, 0.0341706455219537, 0.819993681041524, 0.687636162620038, 0.431776891928166, 0.243875786894932, 0.00814770301803946, 0.421106143388897, 0.430653251009062, 0.595592122757807, 0.984963058726862, 0.528043455909938, 0.523278417764232, 0.786444804864004, 0.0877224092837423, 0.256111980648711, 0.35660412022844, 0.24905545799993, 0.175018487730995, 0.572922080755234, 0.483393148286268, 0.809948969166726, 0.75051523395814, 0.347443797625601, 0.806874484289438, 0.25176422810182, 0.592963553965092, 0.156215733382851, 0.175159651553258, 0.226377300918102, 0.791963252006099, 0.388376479735598, 0.911222032504156, 0.1218470511958, 0.987835156964138, 0.75528792059049, 0.310775833902881, 0.0198653580155224, 0.682283061323687, 0.438736066687852, 0.883700705366209, 0.0742437855806202, 0.45366955595091, 0.888036270625889, 0.700159241678193, 0.304615611210465, 0.584890802390873, 0.870453770039603, 0.44652355927974, 0.33737303968519, 0.566908608656377, 0.415764981647953, 0.83266066480428, 0.153707588091493, 0.658649043180048, 0.00102681899443269, 0.320450928527862, 0.950132880592719, 0.0125525095500052, 0.0790907654445618, 0.213288370519876, 0.994843258988112, 0.49203958758153, 0.627634118078277, 0.00596133503131568, 0.285853998735547, 0.986480417195708, 0.757692324928939, 0.0682749908883125, 0.810763978632167, 0.122871407074854, 0.409918360644951, 0.927543645258993, 0.554208239307627, 0.0142666143365204, 0.967365281190723, 0.770065532531589, 0.0799524132162333, 0.365419848356396, 0.480426545254886, 0.675760691985488, 0.786447250749916, 0.810058057308197, 0.078677503624931, 0.168914441019297, 0.0367327940184623, 0.240142308874056, 0.912195181939751, 0.00136347976513207, 0.227300448110327, 0.168262931751087, 0.149762514978647, 0.648097161203623, 0.485572549281642, 0.693244319409132, 0.289669456658885, 0.978671659715474, 0.288126329425722, 0.525764521211386, 0.0778222696390003, 0.678553835256025, 0.181949716527015, 0.529804455116391, 0.801678828895092, 0.313187195919454, 0.691273411735892, 0.773044522618875, 0.261793632525951, 0.678760153008625, 0.992143295938149, 0.551487519871444, 0.930684473598376, 0.20740434480831, 0.229959039483219, 0.48398658935912, 0.461059393826872, 0.782721356954426, 0.000605266075581312, 0.750623380066827, 0.830732437549159, 0.314671236323193, 0.712033160030842, 0.25171154923737, 0.309347498230636, 0.986753219505772, 0.423095647012815, 0.852890213020146, 0.534399916650727, 0.54817751632072, 0.845543978502974, 0.377029079943895, 0.166043678531423, 0.189248028676957, 0.856867816066369, 0.337503234623, 0.775028235046193, 0.0690702020656317, 0.240949265658855, 0.24280183785595, 0.387112989090383, 0.871805021073669, 0.967197048477829, 0.866916270926595, 0.437715301522985, 0.191937792114913, 0.0822944045066833, 0.583451637532562, 0.0703614954836667, 0.527662655804306, 0.472288285382092, 0.0481913706753403, 0.594540807651356, 0.791271215071902, 0.598868683679029, 0.0279159292113036, 0.39572663186118, 0.106243964517489, 0.0241113880183548, 0.840897767804563, 0.32639992586337, 0.2942976471968, 0.822897979756817, 0.414347424637526, 0.0101712229661644, 0.0524083885829896, 0.730370381381363, 0.0733949469868094, 0.0703566265292466, 0.637171967187896, 0.41330587095581, 0.430717830779031, 0.0802463705185801, 0.277116678655148, 0.794071018928662, 0.0910974657163024, 0.276682177558541, 0.136255458230153, 0.6634760950692, 0.979130022460595, 0.211811334360391, 0.372026984347031, 0.118364716647193, 0.782723808661103, 0.0655782136600465, 0.783775092335418, 0.123852211982012, 0.777341672452167, 0.36134907277301, 0.615930010797456, 0.917042729211971, 0.105220099911094, 0.715545793995261, 0.156366555485874, 0.261575721204281, 0.773791367653757, 0.594759070547298, 0.0953767166938633, 0.158467933768407, 0.701090714894235, 0.269182726275176, 0.296830063685775, 0.562665292294696, 0.345176512375474, 0.996363310841843, 0.214889628114179, 0.590747197624296, 0.40899104741402, 0.539928927551955, 0.809806877514347, 0.0106531432829797, 0.674989556195214, 0.880181554006413, 0.408088765805587, 0.894052134593949, 0.807851313846186, 0.0522684226743877, 0.951139469398186, 0.498940351651981, 0.497459183679894, 0.201222010422498, 0.680997319286689, 0.547304183710366, 0.60957774030976, 0.308182996464893, 0.164061164716259, 0.847399726277217, 0.177070725010708, 0.586210725829005, 0.972556549590081, 0.534099313896149, 0.810916254529729, 0.650906511116773, 0.77098110713996, 0.0345583152957261, 0.558660281123593, 0.120087367016822, 0.686299628112465, 0.914125661132857, 0.560349760344252, 0.575576044851914, 0.51675015501678, 0.658048582263291, 0.588396580191329, 0.0799245799425989, 0.156136253383011, 0.985081367427483, 0.991829797392711, 0.2947561906185, 0.788712464505807, 0.686831065220758, 0.400826663477346, 0.396841136040166, 0.887413940625265, 0.82207809551619, 0.2652450397145, 0.181170874042436, 0.956474067410454, 0.837399842217565, 0.346652631880715, 0.842086441814899, 0.0101301828399301, 0.21454192395322, 0.913734979229048, 0.0486553451046348, 0.87123094429262, 0.65578800602816, 0.219371878309175, 0.00943714333698153, 0.0792144953738898, 0.767450851621106, 0.0332878560293466, 0.774952064268291, 0.393959630047902, 0.784817258594558, 0.0333322957158089, 0.366151578025892, 0.207688439870253, 0.965912537649274, 0.564966007368639, 0.441115951864049, 0.803868116578087, 0.165633277501911, 0.20611856225878, 0.348586677573621, 0.450814907671884, 0.103176732780412, 0.600618461845443, 0.100577907869592, 0.957186109153554, 0.580974439391866, 0.168894380098209, 0.518571133259684, 0.0543228397145867, 0.295023272512481, 0.0324744703248143, 0.413448404753581, 0.710804731585085, 0.43829421675764, 0.476030350895599, 0.379704721504822, 0.779968342510983, 0.961577203124762, 0.443998414091766, 0.276576519012451, 0.652874941704795, 0.754724035272375, 0.588706381851807, 0.36689807055518, 0.509391026105732, 0.144229113589972, 0.266654535662383, 0.173820912605152, 0.896527295233682, 0.562343132682145, 0.342454317957163, 0.283729680348188, 0.747538483235985, 0.562850194750354, 0.565385995432734, 0.633331828983501, 0.962586591951549, 0.768941204063594, 0.761524176690727, 0.152722147526219, 0.367797967977822, 0.913615794153884, 0.496350146830082, 0.0277347269002348, 0.450139385415241, 0.0271877180784941, 0.0182709295768291, 0.871962478850037, 0.955188889289275, 0.892738419119269, 0.856308729154989, 0.123533075442538, 0.22165473876521, 0.690272177569568, 0.648772125830874, 0.0914451922290027, 0.595569584751502, 0.944378237938508, 0.12865765299648, 0.524701888905838, 0.931875708047301, 0.441982066258788, 0.401971613289788, 0.365522500360385, 0.572829977376387, 0.106167400954291, 0.657213832018897, 0.800479157827795, 0.160081139067188, 0.499149806331843, 0.138865772867575, 0.688598210224882, 0.480641926405951, 0.20781287481077, 0.717721335589886, 0.333421071292832, 0.529427384026349, 0.593498748727143, 0.75988901196979, 0.039695909479633, 0.631179952295497, 0.170349805383012, 0.707256585825235, 0.264722274616361, 0.0803224456030875, 0.713207269553095, 0.750814122147858, 0.170225525507703, 0.214822159614414, 0.136855290038511, 0.320704787038267, 0.659653313225135, 0.458246603375301, 0.221783839398995, 0.0496916156262159, 0.842967495322227, 0.460355976829305, 0.044669063994661, 0.330020109890029, 0.350482023321092, 0.236220998689532, 0.209322826238349, 0.289584968937561, 0.299830043222755, 0.893524003913626, 0.762660629115999, 0.10402936860919, 0.758669548435137, 0.414733785670251, 0.22103567654267, 0.00671869982033968, 0.0302505425643176, 0.250101836863905, 0.220494979294017, 0.308080991730094, 0.90889258380048, 0.93850277364254, 0.491904604947194, 0.168020266341045, 0.188894553110003, 0.191555221565068, 0.503481938038021, 0.0811121538281441, 0.794696550583467, 0.571347230114043, 0.967687885509804, 0.87576876883395, 0.705853160005063, 0.115354677662253, 0.160992347402498, 0.335154334548861, 0.988609185442328, 0.914078942500055, 0.535097180167213, 0.246893692528829;

    }

    ~TestData() {
        BOOST_TEST_MESSAGE("tear down fixture " << fixture);
    }
};


// TODO: Example of BOOST_DATA_TEST_CASE and BOOST_PARAM_TEST_CASE.
// TODO: Should be able to replace the for loop with these.


BOOST_FIXTURE_TEST_SUITE(test_peeling_suite, RandomFamily)

//    BOOST_AUTO_TEST_CASE(test_sum_over_child, *utf::fixture(&setup, &teardown)) {
//        for (int t = 0; t <NUM_TEST; ++t) {
//
//            init_family();
//
//            PairedGenotypeArray expected = PairedGenotypeArray::Ones(100, 1);
//            for (int k = 2; k < total_family_size; ++k) {
//                PairedGenotypeArray temp_array = PairedGenotypeArray::Zero(100, 1);
//
//                for (int i = 0; i < trans_matrix[k].rows(); ++i) {
//                    double x = 0;
//                    for (int j = 0; j < trans_matrix[k].cols(); ++j) {
//                        x += trans_matrix[k](i, j) * lower_array[k][j];
//                    }
//                    temp_array(i, 0) = x;
//                }
//                expected *= temp_array;
//            }
//            //Done expected
//
//
//            dng::peel::workspace_t workspace;
//            dng::TransitionVector full_matrix;
//            copy_family_to_workspace(workspace, full_matrix, total_family_size,
//                                     lower_array, upper_array,
//                                     trans_matrix);
//
//            PairedGenotypeArray result = dng::peel::sum_over_child(workspace, family, full_matrix);
//
//            boost_check_matrix(expected, result, 100, 1);
//        }
//    }
//
//
//    BOOST_AUTO_TEST_CASE(test_up_core, *utf::fixture(&setup, &teardown)) {
//
//        for (int t = 0; t <NUM_TEST; ++t) {
//
//            init_family_parent_child_only();
//
//            GenotypeArray expected = DNG_INDIVIDUAL_BUFFER_ZEROS;
//            for (int i = 0; i < 10; ++i) {
//                for (int j = 0; j < 10; ++j) {
//                    expected[i] += trans_matrix[1](i, j) * lower_array[1][j];
//                }
//            }
//            //Done expected
//
//            dng::peel::workspace_t workspace;
//            dng::TransitionVector full_matrix;
//            copy_family_to_workspace(workspace, full_matrix, total_family_size,
//                                     lower_array, upper_array, trans_matrix);
//
//            GenotypeArray result = dng::peel::up_core(workspace, family, full_matrix);
//            boost_check_array(expected, result, 10);
//
//        }
//    }

    BOOST_AUTO_TEST_CASE(test_up) {

        for (int t = 0; t < NUM_TEST; ++t) {
            init_family_parent_child_only();

            GenotypeArray expected = DNG_INDIVIDUAL_BUFFER_ZEROS;
            GenotypeArray expected_fast = DNG_INDIVIDUAL_BUFFER_ZEROS;

            for (int i = 0; i < 10; ++i) {
                for (int j = 0; j < 10; ++j) {
                    expected[i] += trans_matrix[1](i, j) * lower_array[1][j];
                }
                expected_fast[i] = expected[i];
                expected[i] *= lower_array[0][i];
            }
            //Done expected

            dng::peel::workspace_t workspace;
            dng::TransitionVector full_matrix;
            copy_family_to_workspace(workspace, full_matrix, total_family_size,
                                     lower_array, upper_array, trans_matrix);

            dng::peel::up(workspace, family, full_matrix);
            GenotypeArray result = workspace.lower[0];

            dng::peel::up_fast(workspace, family, full_matrix);
            GenotypeArray result_fast = workspace.lower[0];

            boost_check_array(expected, result, 10);
            boost_check_array(expected_fast, result_fast, 10);

        }
    }


    BOOST_AUTO_TEST_CASE(test_to_father) {

    for (int t = 0; t < NUM_TEST; ++t) {

            init_family();

            PairedGenotypeArray all_child_temp = PairedGenotypeArray::Ones(100, 1);
            PairedGenotypeArray all_child = PairedGenotypeArray::Zero(10, 10);
            for (int c = CHILD_OFFSET; c < total_family_size; ++c) {
                PairedGenotypeArray one_child = PairedGenotypeArray::Zero(100, 1);
                for (int i = 0; i < 100; ++i) {
                    for (int j = 0; j < 10; ++j) {
                        one_child(i, 0) += trans_matrix[c](i, j) * lower_array[c][j];
                    }
                }
                all_child_temp *= one_child;
            }

            for (int k = 0; k < 10; ++k) {
                for (int l = 0; l < 10; ++l) {
                    all_child(k,l) = all_child_temp(k*10+l);
                }
            }

            GenotypeArray ga_mum(10);
            for (int j = 0; j < 10; ++j) {
                ga_mum[j] = upper_array[1][j] * lower_array[1][j];
            }

            GenotypeArray expected = DNG_INDIVIDUAL_BUFFER_ZEROS;
            GenotypeArray expected_fast = DNG_INDIVIDUAL_BUFFER_ZEROS;
            for (int i = 0; i < 10; ++i) {
                for (int j = 0; j < 10; ++j) {
                    expected[i] += all_child(i, j) * ga_mum[j];
                }
                expected_fast[i] = expected[i];
                expected[i] *= lower_array[0][i];
            }
            //Done expected

            dng::peel::workspace_t workspace;
            dng::TransitionVector full_matrix;
            copy_family_to_workspace(workspace, full_matrix, total_family_size,
                                     lower_array, upper_array, trans_matrix);

            dng::peel::to_father(workspace, family, full_matrix);
            GenotypeArray result = workspace.lower[0];
            for (int i = 0; i < 10; ++i) {
                BOOST_CHECK_CLOSE(expected[i], result[i], BOOST_CLOSE_PERCENTAGE_THRESHOLD);
            }

            dng::peel::to_father_fast(workspace, family, full_matrix);
            GenotypeArray result_fast = workspace.lower[0];

            boost_check_array(expected, result, 10);
            boost_check_array(expected_fast, result_fast, 10);

        }
    }


    BOOST_AUTO_TEST_CASE(test_to_mother) {

        for (int t = 0; t < NUM_TEST; ++t) {

            init_family();

            PairedGenotypeArray all_child_temp = PairedGenotypeArray::Ones(100, 1);
            PairedGenotypeArray all_child = PairedGenotypeArray::Zero(10, 10);
            for (int c = CHILD_OFFSET; c < total_family_size; ++c) {
                PairedGenotypeArray one_child = PairedGenotypeArray::Zero(100, 1);
                for (int i = 0; i < 100; ++i) {
                    for (int j = 0; j < 10; ++j) {
                        one_child(i, 0) += trans_matrix[c](i, j) * lower_array[c][j];
                    }
                }
                all_child_temp *= one_child;
            }
            for (int k = 0; k < 10; ++k) {
                for (int l = 0; l < 10; ++l) {
                    all_child(k,l) = all_child_temp(k*10+l);
                }
            }

            GenotypeArray ga_dad(10);
            for (int j = 0; j < 10; ++j) {
                ga_dad[j] = upper_array[0][j] * lower_array[0][j];
            }

            GenotypeArray expected = DNG_INDIVIDUAL_BUFFER_ZEROS;
            GenotypeArray expected_fast = DNG_INDIVIDUAL_BUFFER_ZEROS;
            auto temp_child = all_child.transpose();
            for (int i = 0; i < 10; ++i) {
                for (int j = 0; j < 10; ++j) {
                    expected[i] += temp_child(i, j) * ga_dad[j];
                }
                expected_fast[i] = expected[i];
                expected[i] *= lower_array[1][i];
            }
            //Done expected

            dng::peel::workspace_t workspace;
            dng::TransitionVector full_matrix;
            copy_family_to_workspace(workspace, full_matrix, total_family_size,
                                     lower_array, upper_array, trans_matrix);

            dng::peel::to_mother(workspace, family, full_matrix);
            GenotypeArray result = workspace.lower[1];

            dng::peel::to_mother_fast(workspace, family, full_matrix);
            GenotypeArray result_fast = workspace.lower[1];

            boost_check_array(expected, result, 10);
            boost_check_array(expected_fast, result_fast, 10);

        }
    }


    BOOST_AUTO_TEST_CASE(test_to_child) {

        rand_unif = std::uniform_int_distribution<>(2,10); //min 2 childred required

        for (int t = 0; t < NUM_TEST; ++t) {

            init_family();

            PairedGenotypeArray all_child = PairedGenotypeArray::Ones(100, 1);
            for (int c = CHILD_OFFSET + 1; c < total_family_size; ++c) {
                PairedGenotypeArray one_child = PairedGenotypeArray::Zero(100, 1);
                for (int i = 0; i < 100; ++i) {
                    for (int j = 0; j < 10; ++j) {
                        one_child(i, 0) += trans_matrix[c](i, j) * lower_array[c][j];
                    }
                }
                all_child *= one_child;
            }

            GenotypeArray dad_array(10,1);
            GenotypeArray mom_array(10,1);
            for (int j = 0; j < 10; ++j) {
                dad_array[j] = upper_array[0][j] * lower_array[0][j];
                mom_array[j] = upper_array[1][j] * lower_array[1][j];
            }
            PairedGenotypeArray parents_array = PairedGenotypeArray::Zero(100, 1);
            for (int d = 0; d < 10; ++d) {
                for (int m = 0; m < 10; ++m) {
                    parents_array(d * 10 + m, 0) = dad_array[d] * mom_array[m];
                }
            }
            PairedGenotypeArray parents_children = parents_array * all_child;

            GenotypeArray expected = DNG_INDIVIDUAL_BUFFER_ZEROS;
            GenotypeArray expected_fast = DNG_INDIVIDUAL_BUFFER_ZEROS;
            auto temp_m = trans_matrix[2].transpose();
            for (int i = 0; i < 10; ++i) {
                for (int j = 0; j < 100; ++j) {
                    expected[i] += temp_m(i, j) * parents_children(j, 0);
                    expected_fast[i] += temp_m(i, j) * parents_array(j, 0);
                }
            }
            //Done expected

            dng::peel::workspace_t workspace;
            dng::TransitionVector full_matrix;
            copy_family_to_workspace(workspace, full_matrix, total_family_size,
                                     lower_array, upper_array, trans_matrix);

            dng::peel::to_child(workspace, family, full_matrix);
            GenotypeArray result = workspace.upper[2];

            peel::family_members_t family_fast{family[0], family[1], family[2]};
            dng::peel::to_child_fast(workspace, family_fast, full_matrix);
            GenotypeArray result_fast = workspace.upper[2];


            boost_check_array(expected, result, 10);
            boost_check_array(expected_fast, result_fast, 10);

        }
    }
BOOST_AUTO_TEST_SUITE_END()


BOOST_FIXTURE_TEST_SUITE(test_peeling_fixdata_suite, TestData)


BOOST_AUTO_TEST_CASE(test_up_data) {


    dng::peel::workspace_t workspace;
    dng::TransitionVector full_matrix;
    copy_family_to_workspace(workspace, full_matrix, total_family_size,
                             lower_array, upper_array, trans_matrix);

    dng::peel::up(workspace, family_2, full_matrix);
    GenotypeArray result = workspace.lower[0];

    dng::peel::up_fast(workspace, family_2, full_matrix);
    GenotypeArray result_fast = workspace.lower[0];

    GenotypeArray expected_up(10), expected_up_fast(10);
    expected_up_fast << 3.3430828973056, 2.22029449487333, 1.62739827465366, 3.70643095014583, 1.91143848246212, 2.4992488790493, 1.91207012603083, 2.17660126792262, 2.36868872264584, 1.24111124391474;
    expected_up << 2.99773307383735, 0.589507423115583, 0.605593792226304, 2.1232414358226, 1.73598331986789, 0.504053340069859, 1.71778407816098, 2.05618138742155, 1.56522427901286, 0.780800513587572;


    boost_check_array(expected_up, result, 10);
    boost_check_array(expected_up_fast, result_fast, 10);


}

BOOST_AUTO_TEST_CASE(test_to_father_data) {

    dng::peel::workspace_t workspace;
    dng::TransitionVector full_matrix;
    copy_family_to_workspace(workspace, full_matrix, total_family_size,
                             lower_array, upper_array, trans_matrix);

    dng::peel::to_father(workspace, family_3, full_matrix);
    GenotypeArray result = workspace.lower[0];

    dng::peel::to_father_fast(workspace, family_3, full_matrix);
    GenotypeArray result_fast = workspace.lower[0];

    GenotypeArray expected_father(10), expected_father_fast(10);
    expected_father_fast << 4.33771067103314, 4.03881058045834, 4.48157297742325, 4.49904613402911, 4.52922077623378, 3.72932213323946, 3.82894278442746, 3.86313370349634, 3.75936276624941, 3.37825385317204;
    expected_father << 3.88961301371659, 1.07233919790166, 1.6677004128656, 2.57729370975392, 4.11347359158171, 0.752136889292459, 3.43988270186112, 3.64940686900879, 2.48417861709485, 2.12530694288604;

    boost_check_array(expected_father, result, 10);
    boost_check_array(expected_father_fast, result_fast, 10);

}



BOOST_AUTO_TEST_CASE(test_to_mother_data) {

    dng::peel::workspace_t workspace;
    dng::TransitionVector full_matrix;
    copy_family_to_workspace(workspace, full_matrix, total_family_size,
                             lower_array, upper_array, trans_matrix);

    dng::peel::to_mother(workspace, family_3, full_matrix);
    GenotypeArray result = workspace.lower[1];

    dng::peel::to_mother_fast(workspace, family_3, full_matrix);
    GenotypeArray result_fast = workspace.lower[1];

    GenotypeArray expected_mother(10), expected_mother_fast(10);
    expected_mother_fast << 8.06745074359354, 6.4361035153879, 8.6196171651342, 7.58209055048715, 8.81756599118246, 8.3614372364539, 7.93734156732659, 8.1403042945028, 7.00419230250473, 8.32219005557914;
    expected_mother << 0.498457693627425, 1.32567368558992, 1.52185161471928, 5.20906943361276, 3.38685988280818, 6.43698071534047, 3.95040888222994, 5.84163302463957, 6.9475010342192, 3.16272499105873;

    boost_check_array(expected_mother, result, 10);
    boost_check_array(expected_mother_fast, result_fast, 10);

}




BOOST_AUTO_TEST_CASE(test_to_child_data) {


        dng::peel::workspace_t workspace;
        dng::TransitionVector full_matrix;
        copy_family_to_workspace(workspace, full_matrix, total_family_size,
                                 lower_array, upper_array, trans_matrix);

        dng::peel::to_child(workspace, family_4, full_matrix);
        GenotypeArray result = workspace.upper[2];


        dng::peel::to_child_fast(workspace, family_3, full_matrix);
        GenotypeArray result_fast = workspace.upper[2];

        GenotypeArray expected_child_fast(10), expected_child(10);
        expected_child_fast << 2.75347719063559, 2.87968202567104, 3.046221665875, 2.91227976999125, 3.15382723031105, 2.84428624169569, 2.71204971489996, 2.5978369679627, 3.12219866005276, 3.43152703584631;
        expected_child << 7.28219203053222, 7.48208348481895, 7.78264133557065, 7.4666024463944, 8.08269093572769, 7.33041729609076, 6.94066282227986, 6.79197772316118, 8.05831342873138, 8.8500012009858;

        boost_check_array(expected_child, result, 10);
        boost_check_array(expected_child_fast, result_fast, 10);


}


BOOST_AUTO_TEST_SUITE_END()


